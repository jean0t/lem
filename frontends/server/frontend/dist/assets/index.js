(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const o of document.querySelectorAll('link[rel="modulepreload"]'))i(o);new MutationObserver(o=>{for(const u of o)if(u.type==="childList")for(const n of u.addedNodes)n.tagName==="LINK"&&n.rel==="modulepreload"&&i(n)}).observe(document,{childList:!0,subtree:!0});function t(o){const u={};return o.integrity&&(u.integrity=o.integrity),o.referrerPolicy&&(u.referrerPolicy=o.referrerPolicy),o.crossOrigin==="use-credentials"?u.credentials="include":o.crossOrigin==="anonymous"?u.credentials="omit":u.credentials="same-origin",u}function i(o){if(o.ep)return;o.ep=!0;const u=t(o);fetch(o.href,u)}})();var dist={},client={},models={},hasRequiredModels;function requireModels(){return hasRequiredModels||(hasRequiredModels=1,function(r){var e=models&&models.__extends||function(){var a=function(N,s){return a=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(d,f){d.__proto__=f}||function(d,f){for(var w in f)Object.prototype.hasOwnProperty.call(f,w)&&(d[w]=f[w])},a(N,s)};return function(N,s){if(typeof s!="function"&&s!==null)throw new TypeError("Class extends value "+String(s)+" is not a constructor or null");a(N,s);function d(){this.constructor=N}N.prototype=s===null?Object.create(s):(d.prototype=s.prototype,new d)}}();Object.defineProperty(r,"__esModule",{value:!0}),r.createJSONRPCNotification=r.createJSONRPCRequest=r.createJSONRPCSuccessResponse=r.createJSONRPCErrorResponse=r.JSONRPCErrorCode=r.JSONRPCErrorException=r.isJSONRPCResponses=r.isJSONRPCResponse=r.isJSONRPCRequests=r.isJSONRPCRequest=r.isJSONRPCID=r.JSONRPC=void 0,r.JSONRPC="2.0";var t=function(a){return typeof a=="string"||typeof a=="number"||a===null};r.isJSONRPCID=t;var i=function(a){return a.jsonrpc===r.JSONRPC&&a.method!==void 0&&a.result===void 0&&a.error===void 0};r.isJSONRPCRequest=i;var o=function(a){return Array.isArray(a)&&a.every(r.isJSONRPCRequest)};r.isJSONRPCRequests=o;var u=function(a){return a.jsonrpc===r.JSONRPC&&a.id!==void 0&&(a.result!==void 0||a.error!==void 0)};r.isJSONRPCResponse=u;var n=function(a){return Array.isArray(a)&&a.every(r.isJSONRPCResponse)};r.isJSONRPCResponses=n;var l=function(a,N,s){var d={code:a,message:N};return s!=null&&(d.data=s),d},h=function(a){e(N,a);function N(s,d,f){var w=a.call(this,s)||this;return Object.setPrototypeOf(w,N.prototype),w.code=d,w.data=f,w}return N.prototype.toObject=function(){return l(this.code,this.message,this.data)},N}(Error);r.JSONRPCErrorException=h,function(a){a[a.ParseError=-32700]="ParseError",a[a.InvalidRequest=-32600]="InvalidRequest",a[a.MethodNotFound=-32601]="MethodNotFound",a[a.InvalidParams=-32602]="InvalidParams",a[a.InternalError=-32603]="InternalError"}(r.JSONRPCErrorCode||(r.JSONRPCErrorCode={}));var c=function(a,N,s,d){return{jsonrpc:r.JSONRPC,id:a,error:l(N,s,d)}};r.createJSONRPCErrorResponse=c;var v=function(a,N){return{jsonrpc:r.JSONRPC,id:a,result:N??null}};r.createJSONRPCSuccessResponse=v;var p=function(a,N,s){return{jsonrpc:r.JSONRPC,id:a,method:N,params:s}};r.createJSONRPCRequest=p;var y=function(a,N){return{jsonrpc:r.JSONRPC,method:a,params:N}};r.createJSONRPCNotification=y}(models)),models}var internal={},hasRequiredInternal;function requireInternal(){return hasRequiredInternal||(hasRequiredInternal=1,Object.defineProperty(internal,"__esModule",{value:!0}),internal.DefaultErrorCode=void 0,internal.DefaultErrorCode=0),internal}var hasRequiredClient;function requireClient(){if(hasRequiredClient)return client;hasRequiredClient=1;var r=client&&client.__awaiter||function(n,l,h,c){function v(p){return p instanceof h?p:new h(function(y){y(p)})}return new(h||(h=Promise))(function(p,y){function a(d){try{s(c.next(d))}catch(f){y(f)}}function N(d){try{s(c.throw(d))}catch(f){y(f)}}function s(d){d.done?p(d.value):v(d.value).then(a,N)}s((c=c.apply(n,l||[])).next())})},e=client&&client.__generator||function(n,l){var h={label:0,sent:function(){if(p[0]&1)throw p[1];return p[1]},trys:[],ops:[]},c,v,p,y;return y={next:a(0),throw:a(1),return:a(2)},typeof Symbol=="function"&&(y[Symbol.iterator]=function(){return this}),y;function a(s){return function(d){return N([s,d])}}function N(s){if(c)throw new TypeError("Generator is already executing.");for(;y&&(y=0,s[0]&&(h=0)),h;)try{if(c=1,v&&(p=s[0]&2?v.return:s[0]?v.throw||((p=v.return)&&p.call(v),0):v.next)&&!(p=p.call(v,s[1])).done)return p;switch(v=0,p&&(s=[s[0]&2,p.value]),s[0]){case 0:case 1:p=s;break;case 4:return h.label++,{value:s[1],done:!1};case 5:h.label++,v=s[1],s=[0];continue;case 7:s=h.ops.pop(),h.trys.pop();continue;default:if(p=h.trys,!(p=p.length>0&&p[p.length-1])&&(s[0]===6||s[0]===2)){h=0;continue}if(s[0]===3&&(!p||s[1]>p[0]&&s[1]<p[3])){h.label=s[1];break}if(s[0]===6&&h.label<p[1]){h.label=p[1],p=s;break}if(p&&h.label<p[2]){h.label=p[2],h.ops.push(s);break}p[2]&&h.ops.pop(),h.trys.pop();continue}s=l.call(n,h)}catch(d){s=[6,d],v=0}finally{c=p=0}if(s[0]&5)throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}};Object.defineProperty(client,"__esModule",{value:!0}),client.JSONRPCClient=void 0;var t=requireModels(),i=requireInternal(),o=function(){function n(l,h){this._send=l,this.createID=h,this.idToResolveMap=new Map,this.id=0}return n.prototype._createID=function(){return this.createID?this.createID():++this.id},n.prototype.timeout=function(l,h){var c=this;h===void 0&&(h=function(y){return(0,t.createJSONRPCErrorResponse)(y,i.DefaultErrorCode,"Request timeout")});var v=function(y,a){var N=setTimeout(function(){y.forEach(function(s){var d=c.idToResolveMap.get(s);d&&(c.idToResolveMap.delete(s),d(h(s)))})},l);return a().then(function(s){return clearTimeout(N),s},function(s){return clearTimeout(N),Promise.reject(s)})},p=function(y,a){var N=(Array.isArray(y)?y:[y]).map(function(s){return s.id}).filter(u);return v(N,function(){return c.requestAdvanced(y,a)})};return{request:function(y,a,N){var s=c._createID();return v([s],function(){return c.requestWithID(y,a,N,s)})},requestAdvanced:function(y,a){return p(y,a)}}},n.prototype.request=function(l,h,c){return this.requestWithID(l,h,c,this._createID())},n.prototype.requestWithID=function(l,h,c,v){return r(this,void 0,void 0,function(){var p,y;return e(this,function(a){switch(a.label){case 0:return p=(0,t.createJSONRPCRequest)(v,l,h),[4,this.requestAdvanced(p,c)];case 1:return y=a.sent(),y.result!==void 0&&!y.error?[2,y.result]:y.result===void 0&&y.error?[2,Promise.reject(new t.JSONRPCErrorException(y.error.message,y.error.code,y.error.data))]:[2,Promise.reject(new Error("An unexpected error occurred"))]}})})},n.prototype.requestAdvanced=function(l,h){var c=this,v=Array.isArray(l);Array.isArray(l)||(l=[l]);var p=l.filter(function(N){return u(N.id)}),y=p.map(function(N){return new Promise(function(s){return c.idToResolveMap.set(N.id,s)})}),a=Promise.all(y).then(function(N){return v||!N.length?N:N[0]});return this.send(v?l:l[0],h).then(function(){return a},function(N){return p.forEach(function(s){c.receive((0,t.createJSONRPCErrorResponse)(s.id,i.DefaultErrorCode,N&&N.message||"Failed to send a request"))}),a})},n.prototype.notify=function(l,h,c){var v=(0,t.createJSONRPCNotification)(l,h);this.send(v,c).then(void 0,function(){})},n.prototype.send=function(l,h){return r(this,void 0,void 0,function(){return e(this,function(c){return[2,this._send(l,h)]})})},n.prototype.rejectAllPendingRequests=function(l){this.idToResolveMap.forEach(function(h,c){return h((0,t.createJSONRPCErrorResponse)(c,i.DefaultErrorCode,l))}),this.idToResolveMap.clear()},n.prototype.receive=function(l){var h=this;Array.isArray(l)||(l=[l]),l.forEach(function(c){var v=h.idToResolveMap.get(c.id);v&&(h.idToResolveMap.delete(c.id),v(c))})},n}();client.JSONRPCClient=o;var u=function(n){return n!=null};return client}var interfaces={},hasRequiredInterfaces;function requireInterfaces(){return hasRequiredInterfaces||(hasRequiredInterfaces=1,Object.defineProperty(interfaces,"__esModule",{value:!0})),interfaces}var server={},hasRequiredServer;function requireServer(){if(hasRequiredServer)return server;hasRequiredServer=1;var r=server&&server.__assign||function(){return r=Object.assign||function(s){for(var d,f=1,w=arguments.length;f<w;f++){d=arguments[f];for(var g in d)Object.prototype.hasOwnProperty.call(d,g)&&(s[g]=d[g])}return s},r.apply(this,arguments)},e=server&&server.__awaiter||function(s,d,f,w){function g(m){return m instanceof f?m:new f(function(S){S(m)})}return new(f||(f=Promise))(function(m,S){function b(R){try{A(w.next(R))}catch(W){S(W)}}function C(R){try{A(w.throw(R))}catch(W){S(W)}}function A(R){R.done?m(R.value):g(R.value).then(b,C)}A((w=w.apply(s,d||[])).next())})},t=server&&server.__generator||function(s,d){var f={label:0,sent:function(){if(m[0]&1)throw m[1];return m[1]},trys:[],ops:[]},w,g,m,S;return S={next:b(0),throw:b(1),return:b(2)},typeof Symbol=="function"&&(S[Symbol.iterator]=function(){return this}),S;function b(A){return function(R){return C([A,R])}}function C(A){if(w)throw new TypeError("Generator is already executing.");for(;S&&(S=0,A[0]&&(f=0)),f;)try{if(w=1,g&&(m=A[0]&2?g.return:A[0]?g.throw||((m=g.return)&&m.call(g),0):g.next)&&!(m=m.call(g,A[1])).done)return m;switch(g=0,m&&(A=[A[0]&2,m.value]),A[0]){case 0:case 1:m=A;break;case 4:return f.label++,{value:A[1],done:!1};case 5:f.label++,g=A[1],A=[0];continue;case 7:A=f.ops.pop(),f.trys.pop();continue;default:if(m=f.trys,!(m=m.length>0&&m[m.length-1])&&(A[0]===6||A[0]===2)){f=0;continue}if(A[0]===3&&(!m||A[1]>m[0]&&A[1]<m[3])){f.label=A[1];break}if(A[0]===6&&f.label<m[1]){f.label=m[1],m=A;break}if(m&&f.label<m[2]){f.label=m[2],f.ops.push(A);break}m[2]&&f.ops.pop(),f.trys.pop();continue}A=d.call(s,f)}catch(R){A=[6,R],g=0}finally{w=m=0}if(A[0]&5)throw A[1];return{value:A[0]?A[1]:void 0,done:!0}}},i=server&&server.__spreadArray||function(s,d,f){if(f||arguments.length===2)for(var w=0,g=d.length,m;w<g;w++)(m||!(w in d))&&(m||(m=Array.prototype.slice.call(d,0,w)),m[w]=d[w]);return s.concat(m||Array.prototype.slice.call(d))};Object.defineProperty(server,"__esModule",{value:!0}),server.JSONRPCServer=void 0;var o=requireModels(),u=requireInternal(),n=function(){return(0,o.createJSONRPCErrorResponse)(null,o.JSONRPCErrorCode.ParseError,"Parse error")},l=function(s){return(0,o.createJSONRPCErrorResponse)((0,o.isJSONRPCID)(s.id)?s.id:null,o.JSONRPCErrorCode.InvalidRequest,"Invalid Request")},h=function(s){return(0,o.createJSONRPCErrorResponse)(s,o.JSONRPCErrorCode.MethodNotFound,"Method not found")},c=function(){function s(d){d===void 0&&(d={});var f;this.mapErrorToJSONRPCErrorResponse=a,this.nameToMethodDictionary={},this.middleware=null,this.errorListener=(f=d.errorListener)!==null&&f!==void 0?f:console.warn}return s.prototype.hasMethod=function(d){return!!this.nameToMethodDictionary[d]},s.prototype.addMethod=function(d,f){this.addMethodAdvanced(d,this.toJSONRPCMethod(f))},s.prototype.removeMethod=function(d){delete this.nameToMethodDictionary[d]},s.prototype.toJSONRPCMethod=function(d){return function(f,w){var g=d(f.params,w);return Promise.resolve(g).then(function(m){return y(f.id,m)})}},s.prototype.addMethodAdvanced=function(d,f){var w;this.nameToMethodDictionary=r(r({},this.nameToMethodDictionary),(w={},w[d]=f,w))},s.prototype.receiveJSON=function(d,f){var w=this.tryParseRequestJSON(d);return w?this.receive(w,f):Promise.resolve(n())},s.prototype.tryParseRequestJSON=function(d){try{return JSON.parse(d)}catch{return null}},s.prototype.receive=function(d,f){return Array.isArray(d)?this.receiveMultiple(d,f):this.receiveSingle(d,f)},s.prototype.receiveMultiple=function(d,f){return e(this,void 0,void 0,function(){var w,g=this;return t(this,function(m){switch(m.label){case 0:return[4,Promise.all(d.map(function(S){return g.receiveSingle(S,f)}))];case 1:return w=m.sent().filter(v),w.length===1?[2,w[0]]:w.length?[2,w]:[2,null]}})})},s.prototype.receiveSingle=function(d,f){return e(this,void 0,void 0,function(){var w,g;return t(this,function(m){switch(m.label){case 0:return w=this.nameToMethodDictionary[d.method],(0,o.isJSONRPCRequest)(d)?[3,1]:[2,l(d)];case 1:return[4,this.callMethod(w,d,f)];case 2:return g=m.sent(),[2,N(d,g)]}})})},s.prototype.applyMiddleware=function(){for(var d=[],f=0;f<arguments.length;f++)d[f]=arguments[f];this.middleware?this.middleware=this.combineMiddlewares(i([this.middleware],d,!0)):this.middleware=this.combineMiddlewares(d)},s.prototype.combineMiddlewares=function(d){return d.length?d.reduce(this.middlewareReducer):null},s.prototype.middlewareReducer=function(d,f){return function(w,g,m){return d(function(S,b){return f(w,S,b)},g,m)}},s.prototype.callMethod=function(d,f,w){var g=this,m=function(b,C){return d?d(b,C):b.id!==void 0?Promise.resolve(h(b.id)):Promise.resolve(null)},S=function(b){return g.errorListener('An unexpected error occurred while executing "'.concat(f.method,'" JSON-RPC method:'),b),Promise.resolve(g.mapErrorToJSONRPCErrorResponseIfNecessary(f.id,b))};try{return(this.middleware||p)(m,f,w).then(void 0,S)}catch(b){return S(b)}},s.prototype.mapErrorToJSONRPCErrorResponseIfNecessary=function(d,f){return d!==void 0?this.mapErrorToJSONRPCErrorResponse(d,f):null},s}();server.JSONRPCServer=c;var v=function(s){return s!==null},p=function(s,d,f){return s(d,f)},y=function(s,d){return s!==void 0?(0,o.createJSONRPCSuccessResponse)(s,d):null},a=function(s,d){var f,w=(f=d?.message)!==null&&f!==void 0?f:"An unexpected error occurred",g=u.DefaultErrorCode,m;return d instanceof o.JSONRPCErrorException&&(g=d.code,m=d.data),(0,o.createJSONRPCErrorResponse)(s,g,w,m)},N=function(s,d){return d||(s.id!==void 0?(0,o.createJSONRPCErrorResponse)(s.id,o.JSONRPCErrorCode.InternalError,"Internal error"):null)};return server}var serverAndClient={},hasRequiredServerAndClient;function requireServerAndClient(){if(hasRequiredServerAndClient)return serverAndClient;hasRequiredServerAndClient=1;var r=serverAndClient&&serverAndClient.__awaiter||function(o,u,n,l){function h(c){return c instanceof n?c:new n(function(v){v(c)})}return new(n||(n=Promise))(function(c,v){function p(N){try{a(l.next(N))}catch(s){v(s)}}function y(N){try{a(l.throw(N))}catch(s){v(s)}}function a(N){N.done?c(N.value):h(N.value).then(p,y)}a((l=l.apply(o,u||[])).next())})},e=serverAndClient&&serverAndClient.__generator||function(o,u){var n={label:0,sent:function(){if(c[0]&1)throw c[1];return c[1]},trys:[],ops:[]},l,h,c,v;return v={next:p(0),throw:p(1),return:p(2)},typeof Symbol=="function"&&(v[Symbol.iterator]=function(){return this}),v;function p(a){return function(N){return y([a,N])}}function y(a){if(l)throw new TypeError("Generator is already executing.");for(;v&&(v=0,a[0]&&(n=0)),n;)try{if(l=1,h&&(c=a[0]&2?h.return:a[0]?h.throw||((c=h.return)&&c.call(h),0):h.next)&&!(c=c.call(h,a[1])).done)return c;switch(h=0,c&&(a=[a[0]&2,c.value]),a[0]){case 0:case 1:c=a;break;case 4:return n.label++,{value:a[1],done:!1};case 5:n.label++,h=a[1],a=[0];continue;case 7:a=n.ops.pop(),n.trys.pop();continue;default:if(c=n.trys,!(c=c.length>0&&c[c.length-1])&&(a[0]===6||a[0]===2)){n=0;continue}if(a[0]===3&&(!c||a[1]>c[0]&&a[1]<c[3])){n.label=a[1];break}if(a[0]===6&&n.label<c[1]){n.label=c[1],c=a;break}if(c&&n.label<c[2]){n.label=c[2],n.ops.push(a);break}c[2]&&n.ops.pop(),n.trys.pop();continue}a=u.call(o,n)}catch(N){a=[6,N],h=0}finally{l=c=0}if(a[0]&5)throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}};Object.defineProperty(serverAndClient,"__esModule",{value:!0}),serverAndClient.JSONRPCServerAndClient=void 0;var t=requireModels(),i=function(){function o(u,n,l){l===void 0&&(l={});var h;this.server=u,this.client=n,this.errorListener=(h=l.errorListener)!==null&&h!==void 0?h:console.warn}return o.prototype.applyServerMiddleware=function(){for(var u,n=[],l=0;l<arguments.length;l++)n[l]=arguments[l];(u=this.server).applyMiddleware.apply(u,n)},o.prototype.hasMethod=function(u){return this.server.hasMethod(u)},o.prototype.addMethod=function(u,n){this.server.addMethod(u,n)},o.prototype.addMethodAdvanced=function(u,n){this.server.addMethodAdvanced(u,n)},o.prototype.removeMethod=function(u){this.server.removeMethod(u)},o.prototype.timeout=function(u){return this.client.timeout(u)},o.prototype.request=function(u,n,l){return this.client.request(u,n,l)},o.prototype.requestAdvanced=function(u,n){return this.client.requestAdvanced(u,n)},o.prototype.notify=function(u,n,l){this.client.notify(u,n,l)},o.prototype.rejectAllPendingRequests=function(u){this.client.rejectAllPendingRequests(u)},o.prototype.receiveAndSend=function(u,n,l){return r(this,void 0,void 0,function(){var h,c;return e(this,function(v){switch(v.label){case 0:return(0,t.isJSONRPCResponse)(u)||(0,t.isJSONRPCResponses)(u)?(this.client.receive(u),[3,4]):[3,1];case 1:return(0,t.isJSONRPCRequest)(u)||(0,t.isJSONRPCRequests)(u)?[4,this.server.receive(u,n)]:[3,3];case 2:return h=v.sent(),h?[2,this.client.send(h,l)]:[3,4];case 3:return c="Received an invalid JSON-RPC message",this.errorListener(c,u),[2,Promise.reject(new Error(c))];case 4:return[2]}})})},o}();return serverAndClient.JSONRPCServerAndClient=i,serverAndClient}var hasRequiredDist;function requireDist(){return hasRequiredDist||(hasRequiredDist=1,function(r){var e=dist&&dist.__createBinding||(Object.create?function(i,o,u,n){n===void 0&&(n=u);var l=Object.getOwnPropertyDescriptor(o,u);(!l||("get"in l?!o.__esModule:l.writable||l.configurable))&&(l={enumerable:!0,get:function(){return o[u]}}),Object.defineProperty(i,n,l)}:function(i,o,u,n){n===void 0&&(n=u),i[n]=o[u]}),t=dist&&dist.__exportStar||function(i,o){for(var u in i)u!=="default"&&!Object.prototype.hasOwnProperty.call(o,u)&&e(o,i,u)};Object.defineProperty(r,"__esModule",{value:!0}),t(requireClient(),r),t(requireInterfaces(),r),t(requireModels(),r),t(requireServer(),r),t(requireServerAndClient(),r)}(dist)),dist}var distExports=requireDist();class JSONRPC{constructor(e,{onConnected:t,onClosed:i}){this.url=e,this.onConnected=t,this.onClosed=i,this.messageQueue=[],this.serverAndClient=null,this.connect(),this.connectionEstablished=!1,this.timerId=null,this.closed=!1}close(){this.timerId&&clearTimeout(this.timerId),this.webSocket.close(),this.closed=!0}on(e,t){this.serverAndClient.addMethod(e,t)}async requestInternal(e,t,i){const o=await this.serverAndClient.request(e,t);i&&i(o)}requestMessageQueue(){this.messageQueue.forEach(e=>{const[t,i,o]=e;this.requestInternal(t,i,o)}),this.messageQueue=[]}request(e,t,i){this.webSocket.readyState===WebSocket.OPEN?this.requestInternal(e,t,i):this.messageQueue.push([e,t,i])}notify(e,t){switch(this.webSocket.readyState){case WebSocket.OPEN:this.serverAndClient.notify(e,t);break}}connect(e){this.closed||(console.log("connect",this.url),this.webSocket=new WebSocket(this.url),this.serverAndClient||(this.serverAndClient=new distExports.JSONRPCServerAndClient(new distExports.JSONRPCServer,new distExports.JSONRPCClient(t=>{try{return this.webSocket.send(JSON.stringify(t)),Promise.resolve()}catch(i){return Promise.reject(i)}}))),this.webSocket.onmessage=t=>{this.serverAndClient.receiveAndSend(JSON.parse(t.data.toString()))},this.webSocket.onopen=()=>{console.log("WebSocket connection established"),this.connectionEstablished=!0,this.onConnected&&this.onConnected(),this.requestMessageQueue()},this.webSocket.onclose=t=>{console.error("WebScoket closed",t),this.serverAndClient.rejectAllPendingRequests(`Connection is closed (${t.reason}).`),this.connectionEstablished&&this.onClosed(),this.timerId=setTimeout(()=>{this.connect()},3e3)},this.webSocket.onerror=t=>{console.error("WebSocket error:",t),this.webSocket.close()})}}const modifierKeys=["Shift","Control","Alt","Meta"],convertKeyTable={Enter:"Return",ArrowRight:"Right",ArrowLeft:"Left",ArrowUp:"Up",ArrowDown:"Down","¡":"1","™":"2","£":"3","¢":"4","∞":"5","§":"6","¶":"7","•":"8",ª:"9",º:"0","–":"-","≠":"=","“":"[","‘":"]","«":"\\","…":";",æ:"'","≤":",","≥":".","÷":"/","⁄":"!","€":"@","‹":"#","›":"$",ﬁ:"%",ﬂ:"^","‡":"&","°":"*","·":"(","‚":")","—":"_","±":"+","”":"{","’":"}","»":"|",Ú:":",Æ:'"',"¯":"<","˘":">","¿":"?",œ:"q","∑":"w","´":"e","®":"r","†":"t","¥":"y","¨":"u","ˆ":"i",ø:"o",π:"p",å:"a",ß:"s","∂":"d",ƒ:"f","©":"g","˙":"h","∆":"j","˚":"k","¬":"l",Ω:"z","≈":"x",ç:"c","√":"v","∫":"b","˜":"n",µ:"m",Œ:"Q","„":"W","´":"E","‰":"R","ˇ":"T",Á:"Y","¨":"U","ˆ":"I",Ø:"O","∏":"P",Å:"A",Í:"S",Î:"D",Ï:"F","˝":"G",Ó:"H",Ô:"J","":"K",Ò:"L","¸":"Z","˛":"X",Ç:"C","◊":"V",ı:"B","˜":"N",Â:"M"};function getKey(r){return r.altKey?convertKeyTable[r.key]||(r.code.startsWith("Key")?r.code[3].toLowerCase():null)||r.key:convertKeyTable[r.key]||r.key}function convertKeyEvent(r){return modifierKeys.indexOf(r.key)!==-1?null:{key:getKey(r),ctrl:r.ctrlKey,meta:r.altKey,super:r.metaKey,shift:r.shiftKey}}var defs=[[0,31,"N"],[32,126,"Na"],[127,160,"N"],[161,161,"A"],[162,163,"Na"],[164,164,"A"],[165,166,"Na"],[167,168,"A"],[169,169,"N"],[170,170,"A"],[171,171,"N"],[172,172,"Na"],[173,174,"A"],[175,175,"Na"],[176,180,"A"],[181,181,"N"],[182,186,"A"],[187,187,"N"],[188,191,"A"],[192,197,"N"],[198,198,"A"],[199,207,"N"],[208,208,"A"],[209,214,"N"],[215,216,"A"],[217,221,"N"],[222,225,"A"],[226,229,"N"],[230,230,"A"],[231,231,"N"],[232,234,"A"],[235,235,"N"],[236,237,"A"],[238,239,"N"],[240,240,"A"],[241,241,"N"],[242,243,"A"],[244,246,"N"],[247,250,"A"],[251,251,"N"],[252,252,"A"],[253,253,"N"],[254,254,"A"],[255,256,"N"],[257,257,"A"],[258,272,"N"],[273,273,"A"],[274,274,"N"],[275,275,"A"],[276,282,"N"],[283,283,"A"],[284,293,"N"],[294,295,"A"],[296,298,"N"],[299,299,"A"],[300,304,"N"],[305,307,"A"],[308,311,"N"],[312,312,"A"],[313,318,"N"],[319,322,"A"],[323,323,"N"],[324,324,"A"],[325,327,"N"],[328,331,"A"],[332,332,"N"],[333,333,"A"],[334,337,"N"],[338,339,"A"],[340,357,"N"],[358,359,"A"],[360,362,"N"],[363,363,"A"],[364,461,"N"],[462,462,"A"],[463,463,"N"],[464,464,"A"],[465,465,"N"],[466,466,"A"],[467,467,"N"],[468,468,"A"],[469,469,"N"],[470,470,"A"],[471,471,"N"],[472,472,"A"],[473,473,"N"],[474,474,"A"],[475,475,"N"],[476,476,"A"],[477,592,"N"],[593,593,"A"],[594,608,"N"],[609,609,"A"],[610,707,"N"],[708,708,"A"],[709,710,"N"],[711,711,"A"],[712,712,"N"],[713,715,"A"],[716,716,"N"],[717,717,"A"],[718,719,"N"],[720,720,"A"],[721,727,"N"],[728,731,"A"],[732,732,"N"],[733,733,"A"],[734,734,"N"],[735,735,"A"],[736,767,"N"],[768,879,"A"],[880,912,"N"],[913,929,"A"],[930,930,"N"],[931,937,"A"],[938,944,"N"],[945,961,"A"],[962,962,"N"],[963,969,"A"],[970,1024,"N"],[1025,1025,"A"],[1026,1039,"N"],[1040,1103,"A"],[1104,1104,"N"],[1105,1105,"A"],[1106,4351,"N"],[4352,4447,"W"],[4448,8207,"N"],[8208,8208,"A"],[8209,8210,"N"],[8211,8214,"A"],[8215,8215,"N"],[8216,8217,"A"],[8218,8219,"N"],[8220,8221,"A"],[8222,8223,"N"],[8224,8226,"A"],[8227,8227,"N"],[8228,8231,"A"],[8232,8239,"N"],[8240,8240,"A"],[8241,8241,"N"],[8242,8243,"A"],[8244,8244,"N"],[8245,8245,"A"],[8246,8250,"N"],[8251,8251,"A"],[8252,8253,"N"],[8254,8254,"A"],[8255,8307,"N"],[8308,8308,"A"],[8309,8318,"N"],[8319,8319,"A"],[8320,8320,"N"],[8321,8324,"A"],[8325,8360,"N"],[8361,8361,"H"],[8362,8363,"N"],[8364,8364,"A"],[8365,8450,"N"],[8451,8451,"A"],[8452,8452,"N"],[8453,8453,"A"],[8454,8456,"N"],[8457,8457,"A"],[8458,8466,"N"],[8467,8467,"A"],[8468,8469,"N"],[8470,8470,"A"],[8471,8480,"N"],[8481,8482,"A"],[8483,8485,"N"],[8486,8486,"A"],[8487,8490,"N"],[8491,8491,"A"],[8492,8530,"N"],[8531,8532,"A"],[8533,8538,"N"],[8539,8542,"A"],[8543,8543,"N"],[8544,8555,"A"],[8556,8559,"N"],[8560,8569,"A"],[8570,8584,"N"],[8585,8585,"A"],[8586,8591,"N"],[8592,8601,"A"],[8602,8631,"N"],[8632,8633,"A"],[8634,8657,"N"],[8658,8658,"A"],[8659,8659,"N"],[8660,8660,"A"],[8661,8678,"N"],[8679,8679,"A"],[8680,8703,"N"],[8704,8704,"A"],[8705,8705,"N"],[8706,8707,"A"],[8708,8710,"N"],[8711,8712,"A"],[8713,8714,"N"],[8715,8715,"A"],[8716,8718,"N"],[8719,8719,"A"],[8720,8720,"N"],[8721,8721,"A"],[8722,8724,"N"],[8725,8725,"A"],[8726,8729,"N"],[8730,8730,"A"],[8731,8732,"N"],[8733,8736,"A"],[8737,8738,"N"],[8739,8739,"A"],[8740,8740,"N"],[8741,8741,"A"],[8742,8742,"N"],[8743,8748,"A"],[8749,8749,"N"],[8750,8750,"A"],[8751,8755,"N"],[8756,8759,"A"],[8760,8763,"N"],[8764,8765,"A"],[8766,8775,"N"],[8776,8776,"A"],[8777,8779,"N"],[8780,8780,"A"],[8781,8785,"N"],[8786,8786,"A"],[8787,8799,"N"],[8800,8801,"A"],[8802,8803,"N"],[8804,8807,"A"],[8808,8809,"N"],[8810,8811,"A"],[8812,8813,"N"],[8814,8815,"A"],[8816,8833,"N"],[8834,8835,"A"],[8836,8837,"N"],[8838,8839,"A"],[8840,8852,"N"],[8853,8853,"A"],[8854,8856,"N"],[8857,8857,"A"],[8858,8868,"N"],[8869,8869,"A"],[8870,8894,"N"],[8895,8895,"A"],[8896,8977,"N"],[8978,8978,"A"],[8979,8985,"N"],[8986,8987,"W"],[8988,9e3,"N"],[9001,9002,"W"],[9003,9192,"N"],[9193,9196,"W"],[9197,9199,"N"],[9200,9200,"W"],[9201,9202,"N"],[9203,9203,"W"],[9204,9311,"N"],[9312,9449,"A"],[9450,9450,"N"],[9451,9547,"A"],[9548,9551,"N"],[9552,9587,"A"],[9588,9599,"N"],[9600,9615,"A"],[9616,9617,"N"],[9618,9621,"A"],[9622,9631,"N"],[9632,9633,"A"],[9634,9634,"N"],[9635,9641,"A"],[9642,9649,"N"],[9650,9651,"A"],[9652,9653,"N"],[9654,9655,"A"],[9656,9659,"N"],[9660,9661,"A"],[9662,9663,"N"],[9664,9665,"A"],[9666,9669,"N"],[9670,9672,"A"],[9673,9674,"N"],[9675,9675,"A"],[9676,9677,"N"],[9678,9681,"A"],[9682,9697,"N"],[9698,9701,"A"],[9702,9710,"N"],[9711,9711,"A"],[9712,9724,"N"],[9725,9726,"W"],[9727,9732,"N"],[9733,9734,"A"],[9735,9736,"N"],[9737,9737,"A"],[9738,9741,"N"],[9742,9743,"A"],[9744,9747,"N"],[9748,9749,"W"],[9750,9755,"N"],[9756,9756,"A"],[9757,9757,"N"],[9758,9758,"A"],[9759,9791,"N"],[9792,9792,"A"],[9793,9793,"N"],[9794,9794,"A"],[9795,9799,"N"],[9800,9811,"W"],[9812,9823,"N"],[9824,9825,"A"],[9826,9826,"N"],[9827,9829,"A"],[9830,9830,"N"],[9831,9834,"A"],[9835,9835,"N"],[9836,9837,"A"],[9838,9838,"N"],[9839,9839,"A"],[9840,9854,"N"],[9855,9855,"W"],[9856,9874,"N"],[9875,9875,"W"],[9876,9885,"N"],[9886,9887,"A"],[9888,9888,"N"],[9889,9889,"W"],[9890,9897,"N"],[9898,9899,"W"],[9900,9916,"N"],[9917,9918,"W"],[9919,9919,"A"],[9920,9923,"N"],[9924,9925,"W"],[9926,9933,"A"],[9934,9934,"W"],[9935,9939,"A"],[9940,9940,"W"],[9941,9953,"A"],[9954,9954,"N"],[9955,9955,"A"],[9956,9959,"N"],[9960,9961,"A"],[9962,9962,"W"],[9963,9969,"A"],[9970,9971,"W"],[9972,9972,"A"],[9973,9973,"W"],[9974,9977,"A"],[9978,9978,"W"],[9979,9980,"A"],[9981,9981,"W"],[9982,9983,"A"],[9984,9988,"N"],[9989,9989,"W"],[9990,9993,"N"],[9994,9995,"W"],[9996,10023,"N"],[10024,10024,"W"],[10025,10044,"N"],[10045,10045,"A"],[10046,10059,"N"],[10060,10060,"W"],[10061,10061,"N"],[10062,10062,"W"],[10063,10066,"N"],[10067,10069,"W"],[10070,10070,"N"],[10071,10071,"W"],[10072,10101,"N"],[10102,10111,"A"],[10112,10132,"N"],[10133,10135,"W"],[10136,10159,"N"],[10160,10160,"W"],[10161,10174,"N"],[10175,10175,"W"],[10176,10213,"N"],[10214,10221,"Na"],[10222,10628,"N"],[10629,10630,"Na"],[10631,11034,"N"],[11035,11036,"W"],[11037,11087,"N"],[11088,11088,"W"],[11089,11092,"N"],[11093,11093,"W"],[11094,11097,"A"],[11098,11903,"N"],[11904,11929,"W"],[11930,11930,"N"],[11931,12019,"W"],[12020,12031,"N"],[12032,12245,"W"],[12246,12271,"N"],[12272,12287,"W"],[12288,12288,"F"],[12289,12350,"W"],[12351,12352,"N"],[12353,12438,"W"],[12439,12440,"N"],[12441,12543,"W"],[12544,12548,"N"],[12549,12591,"W"],[12592,12592,"N"],[12593,12686,"W"],[12687,12687,"N"],[12688,12771,"W"],[12772,12782,"N"],[12783,12830,"W"],[12831,12831,"N"],[12832,12871,"W"],[12872,12879,"A"],[12880,19903,"W"],[19904,19967,"N"],[19968,42124,"W"],[42125,42127,"N"],[42128,42182,"W"],[42183,43359,"N"],[43360,43388,"W"],[43389,44031,"N"],[44032,55203,"W"],[55204,57343,"N"],[57344,63743,"A"],[63744,64255,"W"],[64256,65023,"N"],[65024,65039,"A"],[65040,65049,"W"],[65050,65071,"N"],[65072,65106,"W"],[65107,65107,"N"],[65108,65126,"W"],[65127,65127,"N"],[65128,65131,"W"],[65132,65280,"N"],[65281,65376,"F"],[65377,65470,"H"],[65471,65473,"N"],[65474,65479,"H"],[65480,65481,"N"],[65482,65487,"H"],[65488,65489,"N"],[65490,65495,"H"],[65496,65497,"N"],[65498,65500,"H"],[65501,65503,"N"],[65504,65510,"F"],[65511,65511,"N"],[65512,65518,"H"],[65519,65532,"N"],[65533,65533,"A"],[65534,94175,"N"],[94176,94180,"W"],[94181,94191,"N"],[94192,94193,"W"],[94194,94207,"N"],[94208,100343,"W"],[100344,100351,"N"],[100352,101589,"W"],[101590,101631,"N"],[101632,101640,"W"],[101641,110575,"N"],[110576,110579,"W"],[110580,110580,"N"],[110581,110587,"W"],[110588,110588,"N"],[110589,110590,"W"],[110591,110591,"N"],[110592,110882,"W"],[110883,110897,"N"],[110898,110898,"W"],[110899,110927,"N"],[110928,110930,"W"],[110931,110932,"N"],[110933,110933,"W"],[110934,110947,"N"],[110948,110951,"W"],[110952,110959,"N"],[110960,111355,"W"],[111356,126979,"N"],[126980,126980,"W"],[126981,127182,"N"],[127183,127183,"W"],[127184,127231,"N"],[127232,127242,"A"],[127243,127247,"N"],[127248,127277,"A"],[127278,127279,"N"],[127280,127337,"A"],[127338,127343,"N"],[127344,127373,"A"],[127374,127374,"W"],[127375,127376,"A"],[127377,127386,"W"],[127387,127404,"A"],[127405,127487,"N"],[127488,127490,"W"],[127491,127503,"N"],[127504,127547,"W"],[127548,127551,"N"],[127552,127560,"W"],[127561,127567,"N"],[127568,127569,"W"],[127570,127583,"N"],[127584,127589,"W"],[127590,127743,"N"],[127744,127776,"W"],[127777,127788,"N"],[127789,127797,"W"],[127798,127798,"N"],[127799,127868,"W"],[127869,127869,"N"],[127870,127891,"W"],[127892,127903,"N"],[127904,127946,"W"],[127947,127950,"N"],[127951,127955,"W"],[127956,127967,"N"],[127968,127984,"W"],[127985,127987,"N"],[127988,127988,"W"],[127989,127991,"N"],[127992,128062,"W"],[128063,128063,"N"],[128064,128064,"W"],[128065,128065,"N"],[128066,128252,"W"],[128253,128254,"N"],[128255,128317,"W"],[128318,128330,"N"],[128331,128334,"W"],[128335,128335,"N"],[128336,128359,"W"],[128360,128377,"N"],[128378,128378,"W"],[128379,128404,"N"],[128405,128406,"W"],[128407,128419,"N"],[128420,128420,"W"],[128421,128506,"N"],[128507,128591,"W"],[128592,128639,"N"],[128640,128709,"W"],[128710,128715,"N"],[128716,128716,"W"],[128717,128719,"N"],[128720,128722,"W"],[128723,128724,"N"],[128725,128727,"W"],[128728,128731,"N"],[128732,128735,"W"],[128736,128746,"N"],[128747,128748,"W"],[128749,128755,"N"],[128756,128764,"W"],[128765,128991,"N"],[128992,129003,"W"],[129004,129007,"N"],[129008,129008,"W"],[129009,129291,"N"],[129292,129338,"W"],[129339,129339,"N"],[129340,129349,"W"],[129350,129350,"N"],[129351,129535,"W"],[129536,129647,"N"],[129648,129660,"W"],[129661,129663,"N"],[129664,129672,"W"],[129673,129679,"N"],[129680,129725,"W"],[129726,129726,"N"],[129727,129733,"W"],[129734,129741,"N"],[129742,129755,"W"],[129756,129759,"N"],[129760,129768,"W"],[129769,129775,"N"],[129776,129784,"W"],[129785,131071,"N"],[131072,196605,"W"],[196606,196607,"N"],[196608,262141,"W"],[262142,917759,"N"],[917760,917999,"A"],[918e3,983039,"N"],[983040,1048573,"A"],[1048574,1048575,"N"],[1048576,1114109,"A"],[1114110,1114111,"N"]];function getEAWOfCodePoint(r){let e=0,t=defs.length-1;for(;e!==t;){const i=e+(t-e>>1),[o,u,n]=defs[i];if(r<o)t=i-1;else if(r>u)e=i+1;else return n}return defs[e][2]}function getEAW(r,e=0){const t=r.codePointAt(e);if(t!==void 0)return getEAWOfCodePoint(t)}const textOffsetY=5,isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);function isWideChar(r){switch(getEAW(r)){case"A":case"F":case"W":return!0;default:return!1}}function isMacOS(){return window.navigator.userAgent.indexOf("Mac OS X")!==-1}function computeFontSize(r){const t=document.createElement("canvas").getContext("2d");t.font=r;const i=t.measureText("W");return[Math.floor(i.width),Math.round(i.fontBoundingBoxAscent+textOffsetY+(i.emHeightDescent||0))]}function drawBlock({ctx:r,x:e,y:t,width:i,height:o,style:u}){r.fillStyle=u,r.fillRect(e,t,i,o)}function drawText({ctx:r,x:e,y:t,text:i,font:o,style:u,option:n}){t+=Math.round(textOffsetY),r.fillStyle=u,r.font=o,r.textBaseline="top";for(const l of i)isWideChar(l)?(r.fillText(l,e,t,n.fontWidth*2),e+=n.fontWidth*2):(r.fillText(l,e,t,n.fontWidth),e+=n.fontWidth)}function drawHorizontalLine({ctx:r,x:e,y:t,width:i,style:o,lineWidth:u=1}){r.strokeStyle=o,r.lineWidth=u,r.setLineDash=[],r.beginPath(),r.moveTo(e,t),r.lineTo(e+i,t),r.stroke()}class Option{constructor({fontName:e,fontSize:t}){this.setFont(e,t),this.foreground="#333",this.background="#ccc"}setFont(e,t){const i=t+"px "+e,[o,u]=computeFontSize(i);this.fontName=e,this.fontSize=t,this.fontWidth=o,this.fontHeight=u,this.font=i}}function getLemEditorElement(){return document.getElementById("lem-editor")}function addMouseEventListeners({dom:r,editor:e,isDraggable:t,draggableStyle:i}){r.addEventListener("contextmenu",n=>{n.preventDefault()});const o=(n,l)=>{n.preventDefault();const[h,c]=e.getDisplayRectangle(),v=n.clientX-h,p=n.clientY-c,y=Math.floor(v/e.option.fontWidth),a=Math.floor(p/e.option.fontHeight);e.jsonrpc.notify("input",{kind:l,value:{x:y,y:a,pixelX:v,pixelY:p,button:n.button,clicks:n.detail}})};r.addEventListener("mousedown",n=>{t&&(document.body.style.cursor=i),e.focusHiddenInput(),o(n,"mousedown")}),r.addEventListener("mouseup",n=>{t&&(document.body.style.cursor="default"),o(n,"mouseup")});let u=0;r.addEventListener("mousemove",n=>{n.preventDefault();const l=Date.now();if(l-u>50){u=l;const[h,c]=e.getDisplayRectangle(),v=n.clientX-h,p=n.clientY-c,y=Math.floor(v/e.option.fontWidth),a=Math.floor(p/e.option.fontHeight);e.jsonrpc.notify("input",{kind:"mousemove",value:{x:y,y:a,pixelX:v,pixelY:p,button:n.buttons===0?null:n.buttons-1}})}}),t&&(r.addEventListener("mouseover",()=>{document.body.style.cursor=i}),r.addEventListener("mouseout",n=>{n.buttons!==1&&(document.body.style.cursor="default")})),r.addEventListener("wheel",n=>{n.preventDefault();const[l,h]=e.getDisplayRectangle(),c=n.clientX-l,v=n.clientY-h,p=Math.floor(c/e.option.fontWidth),y=Math.floor(v/e.option.fontHeight);e.jsonrpc.notify("input",{kind:"wheel",value:{pixelX:c,pixelY:v,x:p,y,wheelX:-Math.round(n.deltaX*.01),wheelY:-Math.round(n.deltaY*.01)}})})}const zIndexTable={"floating-window":200,modeline:100,"vertical-border":100};function zindex(r){return zIndexTable[r]||0}const borderOffsetX=5,borderOffsetY=10;class BaseSurface{constructor({editor:r}){this.editor=r,this.mainDOM=null,this.wrapper=null}delete(){this.wrapper?getLemEditorElement().removeChild(this.wrapper):getLemEditorElement().removeChild(this.mainDOM)}setupDOM({dom:r,isFloating:e,border:t,cssClassName:i}){this.mainDOM=r,e&&t?(this.wrapper=document.createElement("div"),i&&(this.wrapper.className=i),this.wrapper.style.position="absolute",this.wrapper.style.backgroundColor=this.editor.option.background,this.wrapper.style.zIndex=zindex("floating-window"),this.wrapper.appendChild(r),getLemEditorElement().appendChild(this.wrapper)):(i&&(r.className=i),getLemEditorElement().appendChild(r))}move(r,e){const[t,i]=this.editor.getDisplayRectangle(),o=Math.floor(t+r*this.editor.option.fontWidth),u=Math.floor(i+e*this.editor.option.fontHeight);this.wrapper?(this.wrapper.style.left=o-borderOffsetX+"px",this.wrapper.style.top=u-borderOffsetY+"px",this.mainDOM.style.left=borderOffsetX+"px",this.mainDOM.style.top=borderOffsetY+"px"):(this.mainDOM.style.left=o+"px",this.mainDOM.style.top=u+"px")}_resize(r,e){const t=window.devicePixelRatio||1;this.mainDOM.width=r*this.editor.option.fontWidth*t,this.mainDOM.height=e*this.editor.option.fontHeight*t,this.mainDOM.style.width=r*this.editor.option.fontWidth+"px",this.mainDOM.style.height=e*this.editor.option.fontHeight+"px",this.wrapper&&(this.wrapper.style.width=r*this.editor.option.fontWidth+borderOffsetX*2+"px",this.wrapper.style.height=e*this.editor.option.fontHeight+borderOffsetY*2+"px")}drawBlock(r,e,t,i,o){}drawText(r,e,t,i,o){}touch(){}evalIn(code){return eval(code)}}class CanvasSurface extends BaseSurface{constructor({editor:e,view:t,x:i,y:o,width:u,height:n,styles:l,isFloating:h,border:c,cssClassName:v}){super({editor:e});const p=this.setupCanvas(l);this.setupDOM({dom:p,isFloating:h,border:c,cssClassName:v}),this.move(i,o),this.resize(u,n),this.drawingQueue=[],addMouseEventListeners({dom:p,editor:e})}setupCanvas(e){const t=document.createElement("canvas");if(t.style.position="absolute",e)for(let i in e)t.style[i]=e[i];return t}resize(e,t){this._resize(e,t);const i=window.devicePixelRatio||1;this.mainDOM.getContext("2d").scale(i,i)}drawBlock(e,t,i,o,u){const n=this.editor.option;this.drawingQueue.push(function(l){drawBlock({ctx:l,x:e*n.fontWidth,y:t*n.fontHeight,width:i*n.fontWidth,height:o*n.fontHeight,style:u})})}drawText(e,t,i,o,u,n){const l=this.editor.option;this.drawingQueue.push(function(h){if(n=n?`${l.fontSize}px ${n}`:l.font,!u)drawBlock({ctx:h,x:e*l.fontWidth,y:t*l.fontHeight,width:o*l.fontWidth,height:l.fontHeight,style:l.background}),drawText({ctx:h,x:e*l.fontWidth,y:t*l.fontHeight,text:i,style:l.foreground,font:n,option:l});else{let{foreground:c,background:v,bold:p,reverse:y,underline:a}=u;if(c||(c=l.foreground),v||(v=l.background),y){const d=v;v=c,c=d}const N=e*l.fontWidth,s=t*l.fontHeight;drawBlock({ctx:h,x:N,y:s,width:o*l.fontWidth,height:l.fontHeight,style:v}),drawText({ctx:h,x:N,y:s,text:i,style:c,font:p?"bold "+n:n,option:l}),a&&drawHorizontalLine({ctx:h,x:N,y:s+l.fontHeight-2,width:o*l.fontWidth,style:typeof a=="string"?a:c,lineWidth:2})}})}touch(){const e=this.mainDOM.getContext("2d");for(let t of this.drawingQueue)t(e);this.drawingQueue=[]}activate(){this.mainDOM.dataset.store="active"}deactivate(){this.mainDOM.dataset.store="inactive"}}class HTMLSurface extends BaseSurface{constructor({editor:e,x:t,y:i,width:o,height:u,styles:n,option:l,isFloating:h,border:c,html:v}){super({editor:e});const p=document.createElement("iframe");this.setupDOM({dom:p,isFloating:h,border:c}),p.style.position="absolute",p.style.backgroundColor=l.background,p.setAttribute("sandbox","allow-scripts allow-same-origin"),p.srcdoc=v,p.addEventListener("load",()=>{const y=p.contentWindow;y.invokeLem=(a,N)=>parent.postMessage({type:"invoke-lem",method:a,args:N})}),this.iframe=p,this.move(t,i),this.resize(o,u)}resize(e,t){this._resize(e,t)}update(e){const t=this.iframe.contentWindow.scrollY;this.iframe.srcdoc=e,this.iframe.onload=()=>{this.iframe.onload=null,this.iframe.contentWindow.scrollTo(0,t)}}evalIn(e){return this.iframe.contentWindow.eval(e)}}class VerticalBorder{constructor({x:e,y:t,height:i,option:o,editor:u}){this.option=o,this.editor=u,this.line=document.createElement("div"),this.line.className="lem-editor__vertical-border",this.line.style.height=i*o.fontHeight+"px",this.line.style.position="absolute",this.line.style.zIndex=zindex("vertical-border"),getLemEditorElement().appendChild(this.line),this.move(e,t),addMouseEventListeners({dom:this.line,editor:u,isDraggable:!0,draggableStyle:"col-resize"})}delete(){this.line.parentNode.removeChild(this.line)}move(e,t){const[i,o]=this.editor.getDisplayRectangle();this.line.style.left=Math.floor(i+e*this.option.fontWidth-this.option.fontWidth/2)+"px",this.line.style.top=o+t*this.option.fontHeight+"px"}resize(e){this.line.style.height=e*this.option.fontHeight+"px"}}const viewStyles={tile:()=>{},floating:r=>({boxSizing:"border-box",borderColor:r.foreground,backgroundColor:r.background})};function getViewStyle(r,e){return viewStyles[r](e)||{}}class View{constructor({id:e,x:t,y:i,width:o,height:u,useModeline:n,kind:l,type:h,content:c,border:v,borderShape:p,option:y,editor:a}){switch(this.option=y,this.id=e,this.x=t,this.y=i,this.width=o,this.height=u,this.useModeline=n,this.kind=l,this.type=h,this.border=v,this.borderShape=p,this.editor=a,this.leftsideBar=null,l){case"tile":this.mainSurface=this.makeSurface(h,c),this.leftSideBar=new VerticalBorder({x:t,y:i,height:u+(n?1:0),option:y,editor:a});break;case"floating":this.mainSurface=this.makeSurface(h,c),p==="left-border"&&(this.leftSideBar=new VerticalBorder({x:t,y:i,height:u,option:y,editor:a}));break}this.modelineSurface=n?this.makeModelineSurface():null}delete(){this.mainSurface.delete(),this.modelineSurface&&this.modelineSurface.delete(),this.leftSideBar&&this.leftSideBar.delete()}move(e,t){this.x=e,this.y=t,this.mainSurface.move(e,t),this.modelineSurface&&this.modelineSurface.move(e,t+this.height),this.leftSideBar&&this.leftSideBar.move(e,t)}resize(e,t){this.width=e,this.height=t,this.mainSurface.resize(e,t),this.modelineSurface&&(this.modelineSurface.move(this.x,this.y+this.height),this.modelineSurface.resize(e,1)),this.leftSideBar&&this.leftSideBar.resize(t+1)}clear(){this.mainSurface.drawBlock(0,0,this.width,this.height,this.option.background)}clearEol(e,t){this.mainSurface.drawBlock(e,t,this.width-e,1,this.option.background)}clearEob(e,t){this.mainSurface.drawBlock(e,t,this.width,this.height-t,this.option.background)}print(e,t,i,o,u,n){this.mainSurface.drawText(e,t,i,o,u,n)}printToModeline(e,t,i,o,u){this.modelineSurface&&this.modelineSurface.drawText(e,t,i,o,u)}touch(e){this.mainSurface.touch(),this.modelineSurface&&(this.modelineSurface.touch(),e?this.modelineSurface.activate():this.modelineSurface.deactivate())}makeSurface(e,t){switch(e){case"html":return this.makeHTMLSurface(t);case"editor":return this.makeEditorSurface();default:console.error(`unknown type: ${e}`)}}makeHTMLSurface(e){return new HTMLSurface({editor:this.editor,x:this.x,y:this.y,width:this.width,height:this.height,styles:getViewStyle(this.kind,this.option),option:this.option,isFloating:this.kind==="floating",border:this.border,html:e})}makeEditorSurface(){const e=this.borderShape==="left-border"?0:this.border,t=this.kind==="floating";return new CanvasSurface({option:this.editor.option,x:this.x,y:this.y,width:this.width,height:this.height,styles:getViewStyle(this.kind,this.option),editor:this.editor,border:e,isFloating:t,view:this,cssClassName:t&&e?"lem-editor__floating-window--bordered":null})}makeModelineSurface(){const e=new CanvasSurface({option:this.editor.option,x:this.x,y:this.y+this.height,width:this.width,height:1,editor:this.editor,view:this,styles:{zIndex:zindex("modeline")},cssClassName:"lem-editor__mode-line"});return addMouseEventListeners({dom:e.mainDOM,editor:this.editor,isDraggable:!0,draggableStyle:"row-resize"}),e}changeToHTMLContent(e){this.mainSurface.constructor.name==="HTMLSurface"?this.mainSurface.update(e):(this.mainSurface.delete(),this.mainSurface=this.makeHTMLSurface(e))}changeToEditorContent(){this.mainSurface.delete(),this.mainSurface=this.makeEditorSurface()}evalIn(e){return this.mainSurface.evalIn(e)}}function isPasteKeyEvent(r){return isMacOS()?r.metaKey&&r.key==="v":r.ctrlKey&&r.shiftKey&&r.key==="V"}class Input{constructor(e){const t=e.option;this.editor=e,this.composition=!1,this.ignoreKeydownAfterCompositionend=!1,this.span=document.createElement("span"),this.span.style.color=t.foreground,this.span.style.backgroundColor=t.background,this.span.style.position="absolute",this.span.style.zIndex=1e6,this.span.style.top="0",this.span.style.left="0",this.span.style.font=t.font,this.input=document.createElement("input"),this.input.style.backgroundColor="transparent",this.input.style.color="transparent",this.input.style.width="0",this.input.style.padding="0",this.input.style.margin="0",this.input.style.border="none",this.input.style.position="absolute",this.input.style.zIndex="-10",this.input.style.top="0",this.input.style.left="0",this.input.style.font=t.font,this.input.addEventListener("blur",i=>{this.input.focus()}),this.input.addEventListener("input",i=>{this.composition===!1&&(this.input.value="",this.span.innerHTML="",this.input.style.width="0",isMacOS()||this.editor.emitInputString(i.data))}),this.input.addEventListener("paste",async i=>{i.preventDefault();const o=i.clipboardData||window.Clipboard.data,u=o?.getData("text")??o?.getData("text/plain");if(u&&u.length>0){this.editor.emitInputString(u);return}try{if(navigator.clipboard?.readText){const n=await navigator.clipboard.readText();if(n&&n.length>0){this.editor.emitInputString(n);return}}}catch(n){console.warn("clipboard.readText() failed:",n)}alert("Paste failed (permission/environment restriction")}),this.input.addEventListener("keydown",i=>{if(!isPasteKeyEvent(i)&&!(i.isComposing||this.composition)&&i.key!=="Process"){if(this.ignoreKeydownAfterCompositionend&&isSafari){i.preventDefault(),this.ignoreKeydownAfterCompositionend=!1;return}if(!(!isMacOS()&&!i.ctrlKey&&!i.altKey&&i.key.length===1)&&(i.preventDefault(),i.isComposing!==!0&&i.code!==""))return setTimeout(()=>{this.composition||(this.editor.emitInput(i),this.input.value="")},0),!1}}),this.input.addEventListener("compositionstart",i=>{this.composition=!0,this.span.innerHTML=this.input.value,this.input.style.width=this.span.offsetWidth+"px"}),this.input.addEventListener("compositionupdate",i=>{this.span.innerHTML=i.data,this.input.style.width=this.span.offsetWidth+"px"}),this.input.addEventListener("compositionend",i=>{this.composition=!1,this.editor.emitInputString(this.input.value),this.input.value="",this.span.innerHTML=this.input.value,this.input.style.width="0",this.ignoreKeydownAfterCompositionend=!0}),document.body.appendChild(this.input),document.body.appendChild(this.span),this.input.focus()}finalize(){document.body.removeChild(this.input),document.body.removeChild(this.span)}move(e,t){const[i,o]=this.editor.getDisplayRectangle();this.span.style.top=o+t+"px",this.span.style.left=i+e+"px",this.input.style.top=this.span.offsetTop+"px",this.input.style.left=this.span.offsetLeft+"px"}updateForeground(e){this.span.style.color=e}updateBackground(e){this.span.style.backgroundColor=e}}class MessageTable{constructor(){this.map=new Map}register(e,t){for(const i in t){const o=t[i];this.map.set(i,o),e.on(i,o)}}get(e){return this.map.get(e)}}function getDisplayRectangleDefault(){return[0,0,window.innerWidth,window.innerHeight]}class Editor{constructor({getDisplayRectangle:e=getDisplayRectangleDefault,fontName:t,fontSize:i,url:o,onExit:u,onClosed:n}){this.getDisplayRectangle=e,this.option=new Option({fontName:t,fontSize:i}),this.onExit=u,this.input=new Input(this),this.cursors=new Map,this.viewMap=new Map,this.jsonrpc=new JSONRPC(o,{onClosed:()=>{n()}}),this.messageTable=new MessageTable,this.messageTable.register(this.jsonrpc,{"update-foreground":this.updateForeground.bind(this),"update-background":this.updateBackground.bind(this),"make-view":this.makeView.bind(this),"delete-view":this.deleteView.bind(this),"resize-view":this.resize.bind(this),"move-view":this.move.bind(this),"redraw-view-after":this.redrawViewAfter.bind(this),clear:this.clear.bind(this),"clear-eol":this.clearEol.bind(this),"clear-eob":this.clearEob.bind(this),put:this.put.bind(this),"modeline-put":this.modelinePut.bind(this),"update-display":this.updateDisplay.bind(this),"move-cursor":this.moveCursor.bind(this),"change-view":this.changeView.bind(this),"resize-display":this.resizeDisplay.bind(this),bulk:this.bulk.bind(this),exit:this.exitEditor.bind(this),"get-clipboard-text":this.getClipboardText.bind(this),"set-clipboard-text":this.setClipboardText.bind(this),"js-eval":this.jsEval.bind(this),"set-font":this.setFont.bind(this),"get-font":this.getFont.bind(this),"get-display-size":this.getDisplaySize.bind(this),"load-css":this.loadCSS.bind(this)}),this.login(),this.boundedHandleResize=this.handleResize.bind(this),this.focusHiddenInput=this.focusHiddenInput.bind(this)}init(){window.addEventListener("resize",this.boundedHandleResize),document.getElementsByTagName("html")[0].style["background-color"]="#333"}finalize(){window.removeEventListener("resize",this.boundedHandleResize),this.input.finalize()}closeConnection(){this.jsonrpc.close()}emitInput(e){const t=convertKeyEvent(e);if(t){if(t.key==="]"&&t.ctrl&&!t.meta&&!t.super&&!t.shift){this.jsonrpc.notify("input",{kind:"abort"});return}t.key!=="Unidentified"&&this.jsonrpc.notify("input",{kind:"key",value:t})}}emitInputString(e){e?this.jsonrpc.notify("input",{kind:"input-string",value:e}):console.error("unexpected argument",e)}handleResize(e){this.jsonrpc.notify("redraw",{size:this.getDisplaySize()})}focusHiddenInput(){const e=this.input?.input;if(e){try{window.focus()}catch{}requestAnimationFrame(()=>{setTimeout(()=>{e.focus({preventScroll:!0})},0)})}}sendNotification(e,t){this.jsonrpc.notify(e,t)}request(e,t,i){this.jsonrpc.request(e,t,i)}getDisplaySize(){const[e,t,i,o]=this.getDisplayRectangle(),u=Math.floor(i/this.option.fontWidth),n=Math.floor(o/this.option.fontHeight);return{width:u,height:n}}callMessage(e,t){this.messageTable.get(e)(t)}findViewById(e){return this.viewMap.get(e)}login(){this.jsonrpc.request("login",{size:this.getDisplaySize(),foreground:this.option.foreground,background:this.option.background},e=>{if(this.updateForeground(e.foreground),this.updateBackground(e.background),e.views)for(const t of e.views)this.makeView(t);this.jsonrpc.notify("redraw",{size:this.getDisplaySize()})})}updateForeground(e){this.option.foreground=e,this.input.updateForeground(e)}updateBackground(e){this.option.background=e,this.input.updateBackground(e);const t=getLemEditorElement();t.style.backgroundColor=e}makeView({id:e,x:t,y:i,width:o,height:u,use_modeline:n,kind:l,type:h,content:c,border:v,border_shape:p}){const y=new View({option:this.option,id:e,x:t,y:i,width:o,height:u,useModeline:n,kind:l,type:h,content:c,border:v,borderShape:p,editor:this});this.viewMap.set(e,y)}deleteView({viewInfo:{id:e}}){this.findViewById(e).delete(),this.viewMap.delete(e)}resize({viewInfo:{id:e},width:t,height:i}){this.findViewById(e).resize(t,i)}move({viewInfo:{id:e},x:t,y:i}){this.findViewById(e).move(t,i)}redrawViewAfter({viewInfo:{id:e},isActive:t}){this.findViewById(e).touch(t)}clear({viewInfo:{id:e}}){this.findViewById(e).clear()}clearEol({viewInfo:{id:e},x:t,y:i}){this.findViewById(e).clearEol(t,i)}clearEob({viewInfo:{id:e},x:t,y:i}){this.findViewById(e).clearEob(t,i)}put({viewInfo:{id:e},x:t,y:i,text:o,textWidth:u,attribute:n,font:l}){this.findViewById(e).print(t,i,o,u,n,l)}modelinePut({viewInfo:{id:e},x:t,y:i,text:o,textWidth:u,attribute:n}){this.findViewById(e).printToModeline(t,i,o,u,n)}updateDisplay(){}moveCursor({viewInfo:{id:e},x:t,y:i}){const o=this.findViewById(e),u=o.x*this.option.fontWidth+t*this.option.fontWidth,n=o.y*this.option.fontHeight+i*this.option.fontHeight;this.input.move(u,n)}changeView({viewInfo:{id:e},type:t,content:i}){const o=this.findViewById(e);switch(t){case"html":o.changeToHTMLContent(i);break;case"editor":o.changeToEditorContent();break}}resizeDisplay({width:e,height:t}){const i=getLemEditorElement();i.style.width=Math.floor(e*this.option.fontWidth)+"px",i.style.height=Math.floor(t*this.option.fontHeight)+"px"}bulk(e){for(const{method:t,argument:i}of e)this.callMessage(t,i)}exitEditor(){this.onExit&&this.onExit()}getClipboardText(){navigator.clipboard?.readText().then(e=>{this.jsonrpc.notify("got-clipboard-text",{text:e})})}setClipboardText({text:e}){navigator.clipboard&&navigator.clipboard.writeText(e)}jsEval({viewInfo:{id:e},code:t}){const o=this.findViewById(e).evalIn(t);return o&&o.toString()}setFont({fontName:e,fontSize:t}){this.option.setFont(e||this.option.fontName,t||this.option.fontSize)}getFont(){return{name:this.option.fontName,size:this.option.fontSize}}loadCSS({content:e}){const t=document.createElement("style");t.textContent=e,document.head.appendChild(t)}notifyToServer(e,t){this.jsonrpc.notify("invoke",{method:e,args:t})}}const canvas=document.querySelector("#editor");async function main(){await Promise.all([document.fonts.load("19px file-icons"),document.fonts.load("19px AllTheIcons"),document.fonts.load("19px fontawesome"),document.fonts.load("19px material-design-icons"),document.fonts.load("19px octicons")]),await document.fonts.ready;const r=window.location.protocol==="https:"?"wss":"ws",e=new Editor({canvas,fontName:"Monospace",fontSize:19,url:`${r}://${window.location.hostname}:${window.location.port}`,onExit:null,onClosed:null});window.addEventListener("message",t=>{t.data.type==="invoke-lem"&&e.notifyToServer(t.data.method,t.data.args)}),e.init()}main();
